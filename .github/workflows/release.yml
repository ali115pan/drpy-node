name: build-and-release

on:
  push:
    tags:
      - 'v*'  # æ¨é€æ­£å¼ç‰ˆæœ¬tagæ—¶è§¦å‘
  workflow_dispatch: {}  # æ— å‚æ•°æ‰‹åŠ¨è§¦å‘

env:
  NODE_VERSION: '22'

jobs:
  build-and-release:
    runs-on: ubuntu-latest
    permissions:
      contents: write

    steps:
      # æ­¥éª¤1: æ‰‹åŠ¨è§¦å‘æ—¶è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·
      - name: Generate auto version
        if: github.event_name == 'workflow_dispatch'
        run: |
          # ç”Ÿæˆè‡ªåŠ¨ç‰ˆæœ¬å·ï¼Œæ ¼å¼ï¼šv20250122.150530
          AUTO_TAG="v$(date +'%Y%m%d.%H%M%S')"
          echo "AUTO_TAG=${AUTO_TAG}" >> $GITHUB_ENV
          echo "IS_PRERELEASE=true" >> $GITHUB_ENV
          echo "è‡ªåŠ¨ç”Ÿæˆç‰ˆæœ¬å·: ${AUTO_TAG}"

      # æ­¥éª¤2: æ£€å‡ºä»£ç 
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      # æ­¥éª¤3: æ‰‹åŠ¨è§¦å‘æ—¶åˆ›å»ºgit tag
      - name: Create auto tag
        if: github.event_name == 'workflow_dispatch'
        run: |
          git config user.name "github-actions[bot]"
          git config user.email "github-actions[bot]@users.noreply.github.com"
          git tag ${{ env.AUTO_TAG }}
          git push origin ${{ env.AUTO_TAG }}
          echo "å·²åˆ›å»ºå¹¶æ¨é€æ ‡ç­¾: ${{ env.AUTO_TAG }}"

      # æ­¥éª¤4: è®¾ç½®Node.jsç¯å¢ƒ
      - name: Setup Node.js 22
        uses: actions/setup-node@v4
        with:
          node-version: ${{ env.NODE_VERSION }}
          cache: 'npm'

      # æ­¥éª¤5: å®‰è£…7zip
      - name: Install 7zip
        run: |
          sudo apt-get update
          sudo apt-get install -y p7zip-full

      # æ­¥éª¤6: å®‰è£…ä¾èµ–
      - name: Install dependencies
        run: npm ci

      # æ­¥éª¤7: æ„å»ºè„šæœ¬1
      - name: Run packageJS script
        run: npm run packageJS

      # æ­¥éª¤8: æ„å»ºè„šæœ¬2
      - name: Run packageJS-green script
        run: npm run packageJS-green

      # æ­¥éª¤9: æŸ¥æ‰¾ç”Ÿæˆçš„7zæ–‡ä»¶
      - name: Find generated 7z files
        run: |
          cd ..
          echo "æŸ¥æ‰¾ç”Ÿæˆçš„7zæ–‡ä»¶:"
          ls -la *.7z || echo "æœªæ‰¾åˆ°7zæ–‡ä»¶"
          echo "FILES=$(ls *.7z 2>/dev/null | tr '\n' ' ')" >> $GITHUB_ENV
          echo "æ‰¾åˆ°çš„æ–‡ä»¶: $FILES"

      # æ­¥éª¤10: åˆ›å»ºå‘å¸ƒ
      - name: Create Release
        id: create_release
        uses: actions/create-release@v1
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        with:
          tag_name: ${{ github.ref_name || env.AUTO_TAG }}
          release_name: Release ${{ github.ref_name || env.AUTO_TAG }}
          draft: false
          prerelease: ${{ github.event_name == 'workflow_dispatch' }}

      # æ­¥éª¤11: ä¸Šä¼ æ–‡ä»¶åˆ°å‘å¸ƒ
      - name: Upload Release Assets
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          echo "å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°å‘å¸ƒ..."
          cd ..
          
          if [ -z "$FILES" ]; then
            echo "é”™è¯¯: æœªæ‰¾åˆ°ä»»ä½•7zæ–‡ä»¶"
            exit 1
          fi
          
          echo "è¦ä¸Šä¼ çš„æ–‡ä»¶: $FILES"
          
          for file in $FILES; do
            if [ -f "$file" ]; then
              echo "æ­£åœ¨ä¸Šä¼ : $file"
              curl -s \
                -H "Authorization: token $GITHUB_TOKEN" \
                -H "Content-Type: application/octet-stream" \
                --data-binary @"$file" \
                "${{ steps.create_release.outputs.upload_url }}?name=$file"
              echo "âœ“ å·²ä¸Šä¼ : $file"
            else
              echo "è­¦å‘Š: æ–‡ä»¶ä¸å­˜åœ¨ $file"
            fi
          done

      # æ­¥éª¤12: éªŒè¯ç»“æœ
      - name: Verify and output results
        run: |
          echo "========================================"
          echo "ğŸ‰ æ„å»ºå‘å¸ƒå®Œæˆ!"
          echo "ğŸ“¦ ç‰ˆæœ¬å·: ${{ github.ref_name || env.AUTO_TAG }}"
          echo "ğŸ”— å‘å¸ƒé¡µé¢: https://github.com/${{ github.repository }}/releases/tag/${{ github.ref_name || env.AUTO_TAG }}"
          echo "ğŸ“ ä¸Šä¼ æ–‡ä»¶: $FILES"
          echo "========================================"
